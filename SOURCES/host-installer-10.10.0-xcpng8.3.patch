diff --git a/LICENSE b/LICENSE
new file mode 100644
index 0000000..05c5d82
--- /dev/null
+++ b/LICENSE
@@ -0,0 +1,311 @@
+Unless otherwise noted, files in this repository are licensed under the terms
+of the GNU General Public License (GPL) v2 only, a copy of which follows.
+
+Contributions are governed by the license that applies to the relevant
+specific file .
+
+========================================================================
+
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.
+                       59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Library General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+========================================================================
+
+cpiofile.py is licensed under the terms of the MIT license:
+
+Permission  is  hereby granted,  free  of charge,  to  any person
+obtaining a  copy of  this software  and associated documentation
+files  (the  "Software"),  to   deal  in  the  Software   without
+restriction,  including  without limitation  the  rights to  use,
+copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies  of  the  Software,  and to  permit  persons  to  whom the
+Software  is  furnished  to  do  so,  subject  to  the  following
+conditions:
+
+The above copyright  notice and this  permission notice shall  be
+included in all copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS  IS", WITHOUT WARRANTY OF ANY  KIND,
+EXPRESS OR IMPLIED, INCLUDING  BUT NOT LIMITED TO  THE WARRANTIES
+OF  MERCHANTABILITY,  FITNESS   FOR  A  PARTICULAR   PURPOSE  AND
+NONINFRINGEMENT.  IN  NO  EVENT SHALL  THE  AUTHORS  OR COPYRIGHT
+HOLDERS  BE LIABLE  FOR ANY  CLAIM, DAMAGES  OR OTHER  LIABILITY,
+WHETHER  IN AN  ACTION OF  CONTRACT, TORT  OR OTHERWISE,  ARISING
+FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+OTHER DEALINGS IN THE SOFTWARE.
diff --git a/answerfile.py b/answerfile.py
index d73267b..c8c26dd 100644
--- a/answerfile.py
+++ b/answerfile.py
@@ -1,15 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) 2011 Citrix Systems, Inc.
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU Lesser General Public License as published
-# by the Free Software Foundation; version 2.1 only. with the special
-# exception on linking described in file LICENSE.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU Lesser General Public License for more details.
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 """answerfile - parse installation answerfiles"""
 
@@ -101,6 +92,8 @@ class Answerfile:
             else:
                 raise AnswerfileException("Unknown mode, %s" % install_type)
 
+            results['repo-gpgcheck'] = getBoolAttribute(self.top_node, ['repo-gpgcheck'], default=True)
+            results['gpgcheck'] = getBoolAttribute(self.top_node, ['gpgcheck'], default=True)
             results.update(self.parseCommon())
         elif self.operation == 'restore':
             results = self.parseRestore()
@@ -142,6 +135,7 @@ class Answerfile:
         results['preserve-settings'] = False
         results['backup-existing-installation'] = False
 
+        results.update(self.parseRaid())
         results.update(self.parseDisks())
         results.update(self.parseInterface())
         results.update(self.parseRootPassword())
@@ -275,7 +269,21 @@ class Answerfile:
             if rtype == 'url':
                 address = util.URL(address)
 
-            results['sources'].append({'media': rtype, 'address': address})
+            # workaround getBoolAttribute() not allowing "None" as
+            # default, by using a getStrAttribute() call first to
+            # handle the default situation where the attribute is not
+            # specified
+            repo_gpgcheck = (None if getStrAttribute(i, ['repo-gpgcheck'], default=None) is None
+                             else getBoolAttribute(i, ['repo-gpgcheck']))
+            gpgcheck = (None if getStrAttribute(i, ['gpgcheck'], default=None) is None
+                        else getBoolAttribute(i, ['gpgcheck']))
+
+            results['sources'].append({
+                'media': rtype, 'address': address,
+                'repo_gpgcheck': repo_gpgcheck,
+                'gpgcheck': gpgcheck,
+            })
+            logger.log("parsed source %s" % results['sources'][-1])
 
         return results
 
@@ -302,6 +310,16 @@ class Answerfile:
             results['extra-repos'].append((rtype, address))
         return results
 
+    def parseRaid(self):
+        results = {}
+        for raid_node in getElementsByTagName(self.top_node, ['raid']):
+            disk_device = normalize_disk(getStrAttribute(raid_node, ['device'], mandatory=True))
+            disks = [normalize_disk(getText(node)) for node in getElementsByTagName(raid_node, ['disk'])]
+            if 'raid' not in results:
+                results['raid'] = {}
+            results['raid'][disk_device] = disks
+        return results
+
     def parseDisks(self):
         results = {}
 
diff --git a/backend.py b/backend.py
index 5e8fb17..88862a4 100644
--- a/backend.py
+++ b/backend.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Functions to perform the XE installation
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import os.path
@@ -42,6 +32,7 @@ from xcp.version import Version
 import version
 from version import *
 from constants import *
+from diskutil import getRemovableDeviceList
 
 MY_PRODUCT_BRAND = PRODUCT_BRAND or PLATFORM_NAME
 
@@ -113,6 +104,7 @@ def getPrepSequence(ans, interactive):
         Task(util.getUUID, As(ans), ['installation-uuid']),
         Task(util.getUUID, As(ans), ['control-domain-uuid']),
         Task(util.randomLabelStr, As(ans), ['disk-label-suffix']),
+        Task(diskutil.create_raid, A(ans, 'raid'), []),
         Task(inspectTargetDisk, A(ans, 'primary-disk', 'installation-to-overwrite', 'preserve-first-partition','sr-on-primary'), ['target-boot-mode', 'boot-partnum', 'primary-partnum', 'backup-partnum', 'logs-partnum', 'swap-partnum', 'storage-partnum']),
         ]
 
@@ -170,7 +162,7 @@ def getMainRepoSequence(ans, repos):
 def getRepoSequence(ans, repos):
     seq = []
     for repo in repos:
-        seq.append(Task(repo.installPackages, A(ans, 'mounts'), [],
+        seq.append(Task(repo.installPackages, A(ans, 'mounts', 'kernel-alt'), [],
                      progress_scale=100,
                      pass_progress_callback=True,
                      progress_text="Installing %s..." % repo.name()))
@@ -180,6 +172,7 @@ def getRepoSequence(ans, repos):
 
 def getFinalisationSequence(ans):
     seq = [
+        Task(importYumAndRpmGpgKeys, A(ans, 'mounts'), []),
         Task(writeResolvConf, A(ans, 'mounts', 'manual-hostname', 'manual-nameservers'), []),
         Task(writeMachineID, A(ans, 'mounts'), []),
         Task(writeKeyboardConfiguration, A(ans, 'mounts', 'keymap'), []),
@@ -201,6 +194,7 @@ def getFinalisationSequence(ans):
                                   'boot-partnum', 'primary-partnum', 'target-boot-mode', 'branding',
                                   'disk-label-suffix', 'bootloader-location', 'write-boot-entry', 'install-type',
                                   'serial-console', 'boot-serial', 'host-config', 'fcoe-interfaces'), []),
+        Task(postInstallAltKernel, A(ans, 'mounts', 'kernel-alt'), []),
         Task(touchSshAuthorizedKeys, A(ans, 'mounts'), []),
         Task(setRootPassword, A(ans, 'mounts', 'root-password'), [], args_sensitive=True),
         Task(setTimeZone, A(ans, 'mounts', 'timezone'), []),
@@ -328,6 +322,14 @@ def performInstallation(answers, ui_package, interactive):
                                                          default_host_config['dom0-mem'])
                 default_host_config['dom0-vcpus'] = xcp.dom0.default_vcpus(hardware.getHostTotalCPUs(),
                                                                            answers['host-config']['dom0-mem'])
+
+            # Set scheduler granularity if necessary.
+            if 'sched-gran' in answers['host-config']:
+                default_host_config['sched-gran'] = answers['host-config']['sched-gran']
+
+            # Set xen-pciback if necessary.
+            if 'xen-pciback.hide' in answers['host-config']:
+                default_host_config['xen-pciback.hide'] = answers['host-config']['xen-pciback.hide']
         except Exception as e:
             logger.logException(e)
             raise RuntimeError("Failed to get existing installation settings")
@@ -383,7 +385,7 @@ def performInstallation(answers, ui_package, interactive):
     main_repositories = []
     update_repositories = []
 
-    def add_repos(main_repositories, update_repositories, repos):
+    def add_repos(main_repositories, update_repositories, repos, repo_gpgcheck, gpgcheck):
         """Add repositories to the appropriate list, ensuring no duplicates,
         that the main repository is at the beginning, and that the order of the
         rest is maintained."""
@@ -400,20 +402,28 @@ def performInstallation(answers, ui_package, interactive):
                 else:
                     repo_list.append(repo)
 
+                if repo_list is main_repositories: # i.e., if repo is a "main repository"
+                    repo.setRepoGpgCheck(repo_gpgcheck)
+                    repo.setGpgCheck(gpgcheck)
+
+    default_repo_gpgcheck = answers.get('repo-gpgcheck', True)
+    default_gpgcheck = answers.get('gpgcheck', True)
     # A list of sources coming from the answerfile
     if 'sources' in answers_pristine:
         for i in answers_pristine['sources']:
             repos = repository.repositoriesFromDefinition(i['media'], i['address'])
-            add_repos(main_repositories, update_repositories, repos)
+            repo_gpgcheck = default_repo_gpgcheck if i['repo_gpgcheck'] is None else i['repo_gpgcheck']
+            gpgcheck = default_gpgcheck if i['gpgcheck'] is None else i['gpgcheck']
+            add_repos(main_repositories, update_repositories, repos, repo_gpgcheck, gpgcheck)
 
     # A single source coming from an interactive install
     if 'source-media' in answers_pristine and 'source-address' in answers_pristine:
         repos = repository.repositoriesFromDefinition(answers_pristine['source-media'], answers_pristine['source-address'])
-        add_repos(main_repositories, update_repositories, repos)
+        add_repos(main_repositories, update_repositories, repos, default_repo_gpgcheck, default_gpgcheck)
 
     for media, address in answers_pristine['extra-repos']:
         repos = repository.repositoriesFromDefinition(media, address)
-        add_repos(main_repositories, update_repositories, repos)
+        add_repos(main_repositories, update_repositories, repos, default_repo_gpgcheck, default_gpgcheck)
 
     if not main_repositories or main_repositories[0].identifier() != MAIN_REPOSITORY_NAME:
         raise RuntimeError("No main repository found")
@@ -428,6 +438,16 @@ def performInstallation(answers, ui_package, interactive):
         if r.accessor().canEject():
             r.accessor().eject()
 
+    # XCP-ng: so, very unfortunately we don't remember with precision why this was added and
+    # no commit message or comment can help us here.
+    # It may be related to the fact that the "all_repositories" above doesn't contain
+    # the installation CD-ROM or USB stick in the case of a netinstall.
+    # Question: why it is needed at all since there's no repository on the netinstall
+    # installation media?
+    if answers.get('netinstall'):
+        for device in getRemovableDeviceList():
+            util.runCmd2(['eject', device])
+
     if interactive:
         # Add supp packs in a loop
         while True:
@@ -512,7 +532,7 @@ def configureNTP(mounts, ntp_servers):
     util.runCmd2(['chroot', mounts['root'], 'systemctl', 'enable', 'chronyd'])
     util.runCmd2(['chroot', mounts['root'], 'systemctl', 'enable', 'chrony-wait'])
 
-def inspectTargetDisk(disk, existing, create_sr_part, preserve_first_partition):
+def inspectTargetDisk(disk, existing, preserve_first_partition, create_sr_part):
     logger.log("Installer booted in %s mode" % ("UEFI" if constants.UEFI_INSTALLER else "legacy"))
 
     primary_part = 1
@@ -1015,6 +1035,8 @@ def prepFallback(mounts, primary_disk, primary_partnum):
 def buildBootLoaderMenu(mounts, xen_version, xen_kernel_version, boot_config, serial, boot_serial, host_config, primary_disk, disk_label_suffix, fcoe_interfaces):
     short_version = kernelShortVersion(xen_kernel_version)
     common_xen_params = "dom0_mem=%dM,max:%dM" % ((host_config['dom0-mem'],) * 2)
+    if "sched-gran" in host_config:
+        common_xen_params += " %s" % host_config["sched-gran"]
     common_xen_unsafe_params = "watchdog ucode=scan dom0_max_vcpus=1-%d" % host_config['dom0-vcpus']
     safe_xen_params = ("nosmp noreboot noirqbalance no-mce no-bootscrub "
                        "no-numa no-hap no-mmcfg max_cstate=0 "
@@ -1029,6 +1051,9 @@ def buildBootLoaderMenu(mounts, xen_version, xen_kernel_version, boot_config, se
     common_kernel_params = "root=LABEL=%s ro nolvm hpet=disable" % constants.rootfs_label%disk_label_suffix
     kernel_console_params = "console=hvc0"
 
+    if "xen-pciback.hide" in host_config:
+        common_kernel_params += " %s" % host_config["xen-pciback.hide"]
+
     if diskutil.is_iscsi(primary_disk):
         common_kernel_params += " rd.iscsi.ibft=1 rd.iscsi.firmware=1"
 
@@ -1124,7 +1149,11 @@ def installBootLoader(mounts, disk, boot_partnum, primary_partnum, target_boot_m
                 setEfiBootEntry(mounts, disk, boot_partnum, install_type, branding)
         else:
             if location == constants.BOOT_LOCATION_MBR:
-                installGrub2(mounts, disk, False)
+                if diskutil.is_raid(disk):
+                    for member in diskutil.getDeviceSlaves(disk):
+                        installGrub2(mounts, member, False)
+                else:
+                    installGrub2(mounts, disk, False)
             else:
                 installGrub2(mounts, root_partition, True)
 
@@ -1641,6 +1670,57 @@ def touchSshAuthorizedKeys(mounts):
     fh = open("%s/root/.ssh/authorized_keys" % mounts['root'], 'a')
     fh.close()
 
+def importYumAndRpmGpgKeys(mounts):
+    # Python script that uses yum functions to import the GPG key for our repositories
+    import_yum_keys = """#!/bin/env python
+from __future__ import print_function
+from yum import YumBase
+
+def retTrue(*args, **kwargs):
+    return True
+
+base = YumBase()
+for repo in base.repos.repos.itervalues():
+    if repo.id.startswith('xcp-ng'):
+        print("*** Importing GPG key for repository %s - %s" % (repo.id, repo.name))
+        base.getKeyForRepo(repo, callback=retTrue)
+"""
+    internal_tmp_filepath = '/tmp/import_yum_keys.py'
+    external_tmp_filepath = mounts['root'] + internal_tmp_filepath
+    with open(external_tmp_filepath, 'w') as f:
+        f.write(import_yum_keys)
+    # bind mount /dev, necessary for NSS initialization without which RPM won't work
+    util.bindMount('/dev', "%s/dev" % mounts['root'])
+    try:
+        util.runCmd2(['chroot', mounts['root'], 'python', internal_tmp_filepath])
+        util.runCmd2(['chroot', mounts['root'], 'rpm', '--import', '/etc/pki/rpm-gpg/RPM-GPG-KEY-xcpng'])
+    finally:
+        util.umount("%s/dev" % mounts['root'])
+        os.unlink(external_tmp_filepath)
+
+def postInstallAltKernel(mounts, kernel_alt):
+    """ Install our alternate kernel. Must be called after the bootloader installation. """
+    if not kernel_alt:
+        logger.log('kernel-alt not installed')
+        return
+
+    util.bindMount("/proc", "%s/proc" % mounts['root'])
+    util.bindMount("/sys", "%s/sys" % mounts['root'])
+    util.bindMount("/dev", "%s/dev" % mounts['root'])
+
+    try:
+        rc, out = util.runCmd2(['chroot', mounts['root'], 'rpm', '-q', 'kernel-alt', '--qf', '%{version}'],
+                               with_stdout=True)
+        version = out
+        # Generate the initrd as it was disabled during initial installation
+        util.runCmd2(['chroot', mounts['root'], 'dracut', '-f', '/boot/initrd-%s.img' % version, version])
+
+        # Update grub
+        util.runCmd2(['chroot', mounts['root'], 'python', '/usr/lib/python2.7/site-packages/xcp/updategrub.py', 'add', 'kernel-alt', version])
+    finally:
+        util.umount("%s/dev" % mounts['root'])
+        util.umount("%s/sys" % mounts['root'])
+        util.umount("%s/proc" % mounts['root'])
 
 ################################################################################
 # OTHER HELPERS
diff --git a/constants.py b/constants.py
index bfb21b9..dd0534e 100644
--- a/constants.py
+++ b/constants.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Functions to perform the XE installation
-#
-# written by Andrew Peace & Mark Nijmeijer
+# SPDX-License-Identifier: GPL-2.0-only
 
 import version
 import string
@@ -70,15 +60,8 @@ def error_string(error, logname, with_hd):
     ERROR_STRINGS = {
         ERROR_STRING_UNKNOWN_ERROR_WITH_HD: "An unrecoverable error has occurred.  The details of the error can be found in the log file, which has been written to /tmp/%s (and /root/%s on your hard disk if possible).",
         ERROR_STRING_UNKNOWN_ERROR_WITHOUT_HD: "An unrecoverable error has occurred.  The details of the error can be found in the log file, which has been written to /tmp/%s.",
-        ERROR_STRING_KNOWN_ERROR: "An unrecoverable error has occurred.  The error was:\n\n%s\n"
-    }
-
-    if version.PRODUCT_VERSION:
-        ERROR_STRINGS = {
-            ERROR_STRING_UNKNOWN_ERROR_WITH_HD: "An unrecoverable error has occurred.  The details of the error can be found in the log file, which has been written to /tmp/%s (and /root/%s on your hard disk if possible).\n\nPlease refer to your user guide or contact a Technical Support Representative for more details.",
-            ERROR_STRING_UNKNOWN_ERROR_WITHOUT_HD: "An unrecoverable error has occurred.  The details of the error can be found in the log file, which has been written to /tmp/%s.\n\nPlease refer to your user guide or contact a Technical Support Representative for more details.",
-            ERROR_STRING_KNOWN_ERROR: "An unrecoverable error has occurred.  The error was:\n\n%s\n\nPlease refer to your user guide, or contact a Technical Support Representative, for further details."
-            }
+        ERROR_STRING_KNOWN_ERROR: "An unrecoverable error has occurred.  The error was:\n\n%s"
+        }
 
     if error == "":
         if with_hd:
diff --git a/cpiofile.py b/cpiofile.py
old mode 100755
new mode 100644
index 2996ee6..3d17da3
--- a/cpiofile.py
+++ b/cpiofile.py
@@ -1,9 +1,10 @@
 #! /usr/bin/python
-# -*- coding: iso-8859-1 -*-
-#-------------------------------------------------------------------
-# cpiofile.py
-#-------------------------------------------------------------------
-# Copyright (C) 2008
+# -*- coding: utf-8 -*-
+
+# SPDX-License-Identifier: MIT
+#
+# Copyright (C) 2002 Lars Gustaebel <lars@gustaebel.de>
+# Copyright (c) 2008-2019 Citrix Systems, Inc
 # All rights reserved.
 #
 # Permission  is  hereby granted,  free  of charge,  to  any person
@@ -26,15 +27,15 @@
 # WHETHER  IN AN  ACTION OF  CONTRACT, TORT  OR OTHERWISE,  ARISING
 # FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 # OTHER DEALINGS IN THE SOFTWARE.
-#
+
 """Read from and write to cpio format archives.
 
-   Derived from Lars Gust‰bel's tarfile.py
+   Derived from Lars Gust√§bel's tarfile.py
 """
 
 version     = "0.1"
 __author__  = "Simon Rowe"
-__credits__ = "Lars Gust‰bel"
+__credits__ = "Lars Gust√§bel"
 
 #---------
 # Imports
diff --git a/disktools.py b/disktools.py
index 9bb48fb..1ac7687 100644
--- a/disktools.py
+++ b/disktools.py
@@ -1,8 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) Citrix Systems 2009.  All rights reserved.
-# Xen, the Xen logo, XenCenter, XenMotion are trademarks or registered
-# trademarks of Citrix Systems, Inc., in the United States and other
-# countries.
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 import constants
 import re, subprocess, types, os, time
@@ -492,7 +490,7 @@ def diskDevice(partitionDevice):
 
 def determineMidfix(device):
     DISK_PREFIX = '/dev/'
-    P_STYLE_DISKS = [ 'cciss', 'ida', 'rd', 'sg', 'i2o', 'amiraid', 'iseries', 'emd', 'carmel', 'mapper/', 'nvme', 'md' ]
+    P_STYLE_DISKS = [ 'cciss', 'ida', 'rd', 'sg', 'i2o', 'amiraid', 'iseries', 'emd', 'carmel', 'mapper/', 'nvme', 'md', 'mmcblk' ]
     PART_STYLE_DISKS = [ 'disk/by-id' ]
 
     for key in P_STYLE_DISKS:
diff --git a/diskutil.py b/diskutil.py
index b245b89..6d229c2 100644
--- a/diskutil.py
+++ b/diskutil.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Disk discovery and utilities
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import re, sys
 import os.path
@@ -126,6 +116,9 @@ for major in range(48, 56):
 # /dev/md    : md has major 9: each device has 15 minors)
 disk_nodes += [ (9, x * 16) for x in range(16) ]
 
+# /dev/mmcblk: mmcblk has major 179, each device usually (per kernel) has 7 minors
+disk_nodes += [ (179, x * 8) for x in range(32) ]
+
 def getDiskList():
     # read the partition tables:
     parts = open("/proc/partitions")
@@ -166,6 +159,20 @@ def getDiskList():
 
     return disks
 
+def create_raid(configuration):
+    if configuration:
+        for raid_device, members in configuration.viewitems():
+            # allows for idempotence
+            if not os.path.exists(raid_device):
+                for dev in members:
+                    util.runCmd2(['mdadm', '--zero-superblock', '--force', dev])
+                    # let it fail without catching
+                cmd = ['mdadm', '--create', raid_device, '--run', '--metadata=1.0', '--level=mirror',
+                       '--raid-devices=%s' % (len(members))] + members
+                rc, out, err = util.runCmd2(cmd, with_stdout=True, with_stderr=True)
+                if rc != 0:
+                    raise Exception('Error running: %s\n%s\n\n%s' % (' '.join(cmd), out, err))
+
 def getPartitionList():
     disks = getDiskList()
     rv  = []
diff --git a/doc/answerfile.txt b/doc/answerfile.txt
index 7622162..4682c9d 100644
--- a/doc/answerfile.txt
+++ b/doc/answerfile.txt
@@ -33,6 +33,30 @@ Restore:
   ...
 </restore>
 
+
+Common Attributes
+-----------------
+
+  repo-gpgcheck="false"
+
+    Disable check of repodata signature (`repo_gpgcheck=0` in
+    `yum.conf`), for all yum repositories that are not Supplemental
+    Packs (none of which are checked). Don't use this for a network
+    install of a production server, and make sure to verify the
+    authenticity of your install media through other means.
+
+    Validity: any <installation> operation.
+
+
+  gpgcheck="false"
+
+    Disable check of rpm signature (`gpgcheck=0` in `yum.conf`), for
+    all yum repositories that are not Supplemental Packs (none of
+    which are checked). Don't use this for a production server.
+
+    Validity: any <installation> operation.
+
+
 Common Elements
 ---------------
 
@@ -64,6 +88,15 @@ Common Elements
       file:///path/
       nfs://server:/path/
 
+    Optional attributes for <source> only:
+
+      repo-gpgcheck=bool
+      gpgcheck=bool
+
+        Override the global yum gpgcheck setting, respectively for
+        repodata and RPMs, for this source only.  Only applies to
+        repositories that are not Supplemental Packs (none of which
+        are checked).
 
   <bootloader location="mbr|partition">grub2|extlinux[D]|grub[D]</bootloader>?
 
@@ -132,6 +165,16 @@ Common Elements
 (Re)Install Elements
 --------------------
 
+  <raid device=dev>
+    <disk>dev1</disk>
+    <disk>dev2</disk>
+  </raid>?
+
+    Specifies the target disks and md device for creating a
+    software RAID 1 array. The md device can then be used in
+    <primary-disk> below. (new in xcp-ng 7.5.0-2 and 7.6)
+
+
   <primary-disk>dev</primary-disk>
 
     Specifies the target disk for installation.
diff --git a/doc/parameters.txt b/doc/parameters.txt
index ccd1447..2f20e94 100644
--- a/doc/parameters.txt
+++ b/doc/parameters.txt
@@ -216,3 +216,13 @@ Installer
   --cc-preparations
 
     Prepare configuration for common criteria security.
+
+
+  --no-repo-gpgcheck
+
+    Disable check of repodata signature, for all yum repositories.
+
+
+  --no-gpgcheck
+
+    Disable check of rpm signature, for all yum repositories.
diff --git a/driver.py b/driver.py
index fe48714..3c48c63 100644
--- a/driver.py
+++ b/driver.py
@@ -1,15 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
 
-###
-# XEN CLEAN INSTALLER
-# Main script
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import sys
 
diff --git a/fcoeutil.py b/fcoeutil.py
index d640583..ab199ac 100644
--- a/fcoeutil.py
+++ b/fcoeutil.py
@@ -1,15 +1,4 @@
-# Copyright (c) 2015 Citrix Systems, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by Citrix Systems, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of Citrix Systems, Inc. in the United States and/or other
-# countries.
-
-###
-#
-# FCoE util
-#
-###
+# SPDX-License-Identifier: GPL-2.0-only
 
 import re, sys
 import os.path
diff --git a/generalui.py b/generalui.py
index 9410f59..b0c8c36 100644
--- a/generalui.py
+++ b/generalui.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# General functions related to UI
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import time
diff --git a/hardware.py b/hardware.py
index 217cbbb..79bef2c 100644
--- a/hardware.py
+++ b/hardware.py
@@ -1,15 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
 
-###
-# XEN CLEAN INSTALLER
-# Hardware discovery tools
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import constants
 import util
diff --git a/init b/init
index e5ff4ce..b995935 100755
--- a/init
+++ b/init
@@ -1,20 +1,12 @@
 #!/usr/bin/env python
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
 
-###
-# XEN CLEAN INSTALLER
-# Boot script
-#
-# written by Mark Nijmeijer and Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import sys
 import os
 import os.path
 import signal
+import subprocess
 
 # user interface:
 import tui
@@ -125,7 +117,14 @@ def main(args):
     use_ibft = False
     netdev_map = []
 
-    logger.log("%s Setup - Version %s" % (PRODUCT_BRAND or PLATFORM_NAME, PRODUCT_VERSION or PLATFORM_VERSION))
+    try:
+        installer_version = subprocess.check_output(
+            ['rpm', '-q', '--qf', '%{VERSION}-%{RELEASE}', 'host-installer'])
+    except Exception:
+        installer_version = 'unknown'
+
+    logger.log("%s Setup - Version %s" % (PRODUCT_BRAND or PLATFORM_NAME, PRODUCT_VERSION_TEXT))
+    logger.log("Installer Version %s" % (installer_version,))
     logger.log("Command line args: %s" % str(args))
     for (opt, val) in args.items():
         if opt == "--install":
diff --git a/init_constants.py b/init_constants.py
index a256b1c..ad2b25b 100644
--- a/init_constants.py
+++ b/init_constants.py
@@ -1,14 +1,6 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
+# SPDX-License-Identifier: GPL-2.0-only
 
-###
-# XEN CLEAN INSTALLER
 # Constants for use only by boot script
-#
-# written by Andrew Peace
 
 OPERATION_REBOOT = -1
 (
diff --git a/install.py b/install.py
index 8c815f4..c23969e 100755
--- a/install.py
+++ b/install.py
@@ -1,15 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
 
-###
-# XEN HOST INSTALLER
-# Main script
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import sys
 import traceback
@@ -106,6 +97,7 @@ def go(ui, args, answerfile_address, answerfile_script):
         'network-backend': constants.NETWORK_BACKEND_DEFAULT,
         'root-password': ('pwdhash', '!!'),
         'services': { s: None for s in constants.SERVICES }, # default state for services, example {'sshd': None}
+        'preserve-first-partition': constants.PRESERVE_IF_UTILITY,
         }
     suppress_extra_cd_dialog = False
     serial_console = None
@@ -136,6 +128,20 @@ def go(ui, args, answerfile_address, answerfile_script):
         elif opt == "--cc-preparations":
             constants.CC_PREPARATIONS = True
             results['network-backend'] = constants.NETWORK_BACKEND_BRIDGE
+        # XCP-ng addition: alternate kernel
+        elif opt == "--kernel-alt":
+            results['kernel-alt'] = True
+            logger.log("Using alternate kernel.")
+        # XCP-ng: netinstall
+        elif opt == "--netinstall":
+            results['netinstall'] = True
+            logger.log("This is a netinstall.")
+        elif opt == "--no-repo-gpgcheck":
+            results['repo-gpgcheck'] = False
+            logger.log("Yum gpg check of repository disabled on command-line")
+        elif opt == "--no-gpgcheck":
+            results['gpgcheck'] = False
+            logger.log("Yum gpg check of RPMs disabled on command-line")
 
     if boot_console and not serial_console:
         serial_console = boot_console
diff --git a/netinterface.py b/netinterface.py
index 47a9716..0cdcad4 100644
--- a/netinterface.py
+++ b/netinterface.py
@@ -1,12 +1,4 @@
-# Copyright (c) 2008 Citrix Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by Citrix Inc. All other rights reserved.
-
-###
-# XEN HOST INSTALLER
-# Wrapper for network interfaces
-#
-# written by Simon Rowe
+# SPDX-License-Identifier: GPL-2.0-only
 
 import util
 import netutil
diff --git a/netutil.py b/netutil.py
index 00ec707..898fe0e 100644
--- a/netutil.py
+++ b/netutil.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Network interface management utils
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import diskutil
diff --git a/product.py b/product.py
index b4783cc..9760bab 100644
--- a/product.py
+++ b/product.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Manage product installations
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 
@@ -47,6 +37,7 @@ class ExistingInstallation:
         self.root_fs = None
         self._boot_fs = None
         self.boot_fs_mount = None
+        self.detailed_version = ''
 
     def __str__(self):
         return "%s %s" % (
@@ -385,6 +376,20 @@ class ExistingInstallation:
             (dom0_mem, dom0_mem_min, dom0_mem_max) = xcp.dom0.parse_mem(dom0_mem_arg[0])
             if dom0_mem:
                 results['host-config']['dom0-mem'] = dom0_mem / 1024 / 1024
+
+            #   - sched-gran
+            sched_gran = next((x for x in xen_args if x.startswith('sched-gran=')), None)
+            if sched_gran:
+                results['host-config']['sched-gran'] = sched_gran
+
+            # Subset of dom0 kernel arguments
+            kernel_args = boot_config.menu[boot_config.default].getKernelArgs()
+
+            #   - xen-pciback.hide
+            pciback = next((x for x in kernel_args if x.startswith('xen-pciback.hide=')), None)
+            if pciback:
+                results['host-config']['xen-pciback.hide'] = pciback
+
         except:
             pass
         self.unmount_boot()
@@ -419,7 +424,7 @@ class ExistingRetailInstallation(ExistingInstallation):
         self.readInventory()
 
     def __repr__(self):
-        return "<ExistingRetailInstallation: %s on %s>" % (str(self), self.root_device)
+        return "<ExistingRetailInstallation: %s (%s) on %s>" % (str(self), self.detailed_version, self.root_device)
 
     def mount_root(self, ro=True, boot_device=None):
         opts = None
@@ -468,10 +473,8 @@ class ExistingRetailInstallation(ExistingInstallation):
                 self.oem_version = self.inventory['OEM_VERSION']
                 self.visual_version = self.inventory['OEM_VERSION'] + build_suffix
             else:
-                if self.build is not None and '/' in self.build:
-                    self.visual_version = self.inventory['PRODUCT_VERSION']
-                else:
-                    self.visual_version = self.inventory['PRODUCT_VERSION'] + build_suffix
+                self.visual_version = self.inventory['PRODUCT_VERSION_TEXT']
+                self.detailed_version = self.inventory['PRODUCT_VERSION'] + build_suffix
         finally:
             self.unmount_root()
 
@@ -481,6 +484,7 @@ class XenServerBackup:
         self.inventory = util.readKeyValueFile(os.path.join(mnt, constants.INVENTORY_FILE), strip_quotes=True)
         self.build = self.inventory.get('BUILD_NUMBER', None)
         build_suffix = ('-' + self.build) if self.build is not None else ''
+        self.detailed_version = ''
         self.version = Version.from_string(self.inventory['PLATFORM_VERSION'] +
                                            build_suffix)
         if 'PRODUCT_NAME' in self.inventory:
@@ -499,10 +503,8 @@ class XenServerBackup:
             self.oem_version = self.inventory['OEM_VERSION']
             self.visual_version = self.inventory['OEM_VERSION'] + build_suffix
         else:
-            if self.build is not None and '/' in self.build:
-                self.visual_version = self.inventory['PRODUCT_VERSION']
-            else:
-                self.visual_version = self.inventory['PRODUCT_VERSION'] + build_suffix
+            self.visual_version = self.inventory['PRODUCT_VERSION_TEXT']
+            self.detailed_version = self.inventory['PRODUCT_VERSION'] + build_suffix
 
         if self.inventory['PRIMARY_DISK'].startswith('/dev/md_'):
             # Handle restoring an installation using a /dev/md_* path
@@ -516,7 +518,7 @@ class XenServerBackup:
             self.visual_brand, self.visual_version)
 
     def __repr__(self):
-        return "<XenServerBackup: %s on %s>" % (str(self), self.partition)
+        return "<XenServerBackup: %s (%s) on %s>" % (str(self), self.detailed_version, self.partition)
 
 def findXenSourceBackups():
     """Scans the host and find partitions containing backups of XenSource
@@ -531,6 +533,7 @@ def findXenSourceBackups():
             b = util.TempMount(p, 'backup-', ['ro'], 'ext3')
             if os.path.exists(os.path.join(b.mount_point, '.xen-backup-partition')):
                 backup = XenServerBackup(p, b.mount_point)
+                logger.log("Found a backup: %s" % (repr(backup),))
                 if backup.version >= XENSERVER_MIN_VERSION and \
                         backup.version <= THIS_PLATFORM_VERSION:
                     backups.append(backup)
@@ -563,7 +566,7 @@ def findXenSourceProducts():
             logger.log("This is not fatal.  Continuing anyway.")
 
         if inst:
-            logger.log("Found an installation: %s on %s" % (str(inst), disk))
+            logger.log("Found an installation: %s" % (repr(inst),))
             installs.append(inst)
 
     return installs
diff --git a/report.py b/report.py
index bc51c18..370a00a 100644
--- a/report.py
+++ b/report.py
@@ -1,8 +1,6 @@
 #!/usr/bin/env python
-# Copyright (c) Citrix Systems 2010.  All rights reserved.
-# Xen, the Xen logo, XenCenter, XenMotion are trademarks or registered
-# trademarks of Citrix Systems, Inc., in the United States and other
-# countries.
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 import diskutil
 import ftplib
diff --git a/repository.py b/repository.py
index 26612a5..1f5c68b 100644
--- a/repository.py
+++ b/repository.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Packaging functions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import os.path
@@ -191,7 +181,7 @@ class YumRepository(Repository):
         installed_repos[str(self)] = self
         return installed_repos
 
-    def _installPackages(self, progress_callback, mounts):
+    def _installPackages(self, progress_callback, mounts, kernel_alt):
         assert self._targets is not None
         url = self._accessor.url()
         logger.log("URL: " + str(url))
@@ -213,13 +203,15 @@ baseurl=%s
                 yum_conf.write(repo_config)
 
         self.disableInitrdCreation(mounts['root'])
+        if kernel_alt:
+            self._targets.append('kernel-alt')
         installFromYum(self._targets, mounts, progress_callback, self._cachedir)
         self.enableInitrdCreation()
 
-    def installPackages(self, progress_callback, mounts):
+    def installPackages(self, progress_callback, mounts, kernel_alt=False):
         self._accessor.start()
         try:
-            self._installPackages(progress_callback, mounts)
+            self._installPackages(progress_callback, mounts, kernel_alt)
         finally:
             self._accessor.finish()
 
@@ -246,12 +238,14 @@ class MainYumRepository(YumRepositoryWithInfo):
     """Represents a Yum repository containing the main XenServer installation."""
 
     INFO_FILENAME = ".treeinfo"
-    _targets = ['@xenserver_base', '@xenserver_dom0']
+    _targets = ['xcp-ng-deps']
 
     def __init__(self, accessor):
         super(MainYumRepository, self).__init__(accessor)
         self._identifier = MAIN_REPOSITORY_NAME
         self.keyfiles = []
+        self._repo_gpg_check = True
+        self._gpg_check = True
 
         def get_name_version(config_parser, section, name_key, vesion_key):
             name, version = None, None
@@ -322,10 +316,10 @@ class MainYumRepository(YumRepositoryWithInfo):
                 outfh = open(key_path, "w")
                 outfh.write(infh.read())
                 return """
-gpgcheck=1
-repo_gpgcheck=1
+gpgcheck=%s
+repo_gpgcheck=%s
 gpgkey=file://%s
-""" % (key_path)
+""" % (int(self._gpg_check), int(self._repo_gpg_check), key_path)
             finally:
                 if infh:
                     infh.close()
@@ -361,6 +355,13 @@ gpgkey=file://%s
             branding['product-build'] = self._build_number
         return branding
 
+    def setRepoGpgCheck(self, value):
+        logger.log("%s: setRepoGpgCheck(%s)" % (self, value))
+        self._repo_gpg_check = value
+
+    def setGpgCheck(self, value):
+        logger.log("%s: setGpgCheck(%s)" % (self, value))
+        self._gpg_check = value
 
 class UpdateYumRepository(YumRepositoryWithInfo):
     """Represents a Yum repository containing packages and associated meta data for an update."""
diff --git a/restore.py b/restore.py
index 5801e12..01637f6 100644
--- a/restore.py
+++ b/restore.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Functions to perform restore from backup partition, including UI.
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import backend
 import product
@@ -35,7 +25,7 @@ def restoreFromBackup(backup, progress=lambda x: ()):
     tool = PartitionTool(disk)
     _, _, _, storage, _ = diskutil.probeDisk(disk)
     create_sr_part = storage[0] is not None
-    _, boot_partnum, primary_partnum, backup_partnum, logs_partnum, swap_partnum, _ = backend.inspectTargetDisk(disk, None, [], constants.PRESERVE_IF_UTILITY, create_sr_part, True)
+    _, boot_partnum, primary_partnum, backup_partnum, logs_partnum, swap_partnum, _ = backend.inspectTargetDisk(disk, None, constants.PRESERVE_IF_UTILITY, create_sr_part)
 
     backup_fs = util.TempMount(backup.partition, 'backup-', options=['ro'])
     inventory = util.readKeyValueFile(os.path.join(backup_fs.mount_point, constants.INVENTORY_FILE), strip_quotes=True)
@@ -145,7 +135,11 @@ def restoreFromBackup(backup, progress=lambda x: ()):
                     backend.setEfiBootEntry(mounts, disk, boot_partnum, constants.INSTALL_TYPE_RESTORE, branding)
                 else:
                     if location == constants.BOOT_LOCATION_MBR:
-                        backend.installGrub2(mounts, disk, False)
+                        if diskutil.is_raid(disk):
+                            for member in diskutil.getDeviceSlaves(disk):
+                                backend.installGrub2(mounts, member, False)
+                        else:
+                            backend.installGrub2(mounts, disk, False)
                     else:
                         backend.installGrub2(mounts, restore_partition, True)
             else:
diff --git a/scripts.py b/scripts.py
index 1b77aea..6d33a9e 100644
--- a/scripts.py
+++ b/scripts.py
@@ -1,7 +1,4 @@
-# Copyright (c) Citrix Systems 2009.  All rights reserved.
-# Xen, the Xen logo, XenCenter, XenMotion are trademarks or registered
-# trademarks of Citrix Systems, Inc., in the United States and other
-# countries.
+# SPDX-License-Identifier: GPL-2.0-only
 
 import constants
 import os
diff --git a/snackutil.py b/snackutil.py
index 3df33e6..b7fb8a5 100644
--- a/snackutil.py
+++ b/snackutil.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Text user interface helper functions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from snack import *
 
diff --git a/startup/preinit b/startup/preinit
index 860d9ad..4bbbb4f 100755
--- a/startup/preinit
+++ b/startup/preinit
@@ -1,18 +1,9 @@
 #!/bin/bash
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this 
-# copyrighted material is governed by and subject to terms and conditions 
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or 
-# trademarks of XenSource Inc. in the United States and/or other countries.
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 . /etc/init.d/installer-functions
 
-###
-# XEN CLEAN INSTALLER
-# Startup script
-#
-# by Andrew Peace
-
 # Test if started by systemd (or recursively by preinit)
 if [ "$1" == "--" ] ; then
     started_by_systemd=1
diff --git a/support.sh b/support.sh
index 38d84f2..072450d 100755
--- a/support.sh
+++ b/support.sh
@@ -1,9 +1,6 @@
 #!/bin/bash
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this 
-# copyrighted material is governed by and subject to terms and conditions 
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or 
-# trademarks of XenSource Inc. in the United States and/or other countries.
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 SUPPORT_FILE="/tmp/support.tar.bz2"
 echo "Collecting logs for submission to Technical Support..."
diff --git a/tui/__init__.py b/tui/__init__.py
index ff11752..b0d709b 100644
--- a/tui/__init__.py
+++ b/tui/__init__.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Text user interface functions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from snack import *
 from version import *
@@ -18,6 +8,7 @@ import traceback
 import constants
 import sys
 from xcp import logger
+import platform
 
 screen = None
 help_pad = [33, 17, 16]
@@ -38,7 +29,7 @@ To advance to the next screen navigate to the Ok button and press Enter or press
 def init_ui():
     global screen
     screen = SnackScreen()
-    screen.drawRootText(0, 0, "Welcome to %s - Version %s" % (PRODUCT_BRAND or PLATFORM_NAME, PRODUCT_VERSION or PLATFORM_VERSION))
+    screen.drawRootText(0, 0, "Welcome to %s - Version %s (Kernel %s)" % (PRODUCT_BRAND or PLATFORM_NAME, PRODUCT_VERSION_TEXT, platform.release()))
     if PRODUCT_BRAND:
         if len(COPYRIGHT_YEARS) > 0:
             screen.drawRootText(0, 1, "Copyright (c) %s %s" % (COPYRIGHT_YEARS, COMPANY_NAME_LEGAL))
diff --git a/tui/fcoe.py b/tui/fcoe.py
index 392e17d..5957ec8 100644
--- a/tui/fcoe.py
+++ b/tui/fcoe.py
@@ -1,15 +1,4 @@
-# Copyright (c) 2015 Citrix Systems, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by Citrix Systems, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of Citrix Systems, Inc. in the United States and/or other
-# countries.
-
-###
-#
-# FCoE tui
-#
-###
+# SPDX-License-Identifier: GPL-2.0-only
 
 import re, sys
 import os.path
diff --git a/tui/init.py b/tui/init.py
index 292b252..6518555 100644
--- a/tui/init.py
+++ b/tui/init.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# 'Init' text user interface
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from snack import *
 from version import *
@@ -111,7 +101,7 @@ def confirm_proceed():
     b = snackutil.ButtonChoiceWindowEx(
         tui.screen,
         "Confirm Local Disk Format",
-        "WARNING: proceeding with this installation will reinstall your local hard disk with %s %s" % (PRODUCT_BRAND, PRODUCT_VERSION),
+        "WARNING: proceeding with this installation will reinstall your local hard disk with %s %s" % (PRODUCT_BRAND, PRODUCT_VERSION_TEXT),
         ['Proceed', 'Cancel'], default=1, width=50
     )
 
diff --git a/tui/installer/__init__.py b/tui/installer/__init__.py
index fa230e6..c05a5cc 100644
--- a/tui/installer/__init__.py
+++ b/tui/installer/__init__.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Installer TUI sequence definitions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import tui.installer.screens
 import tui.progress
@@ -24,6 +14,7 @@ import product
 import diskutil
 from disktools import *
 import version
+import ssl
 import xmlrpclib
 
 from snack import *
@@ -101,10 +92,13 @@ def runMainSequence(results, ram_warning, vt_warning, suppress_extra_cd_dialog):
         settings = answers['installation-to-overwrite'].readSettings()
         if settings['master']:
             if not netutil.networkingUp():
-                pass
+                return ret
 
             try:
-                s = xmlrpclib.Server("http://"+settings['master'])
+                context = ssl.create_default_context()
+                context.check_hostname = False
+                context.verify_mode = ssl.CERT_NONE
+                s = xmlrpclib.Server("https://"+settings['master'], context=context)
                 session = s.session.slave_login("", settings['pool-token'])["Value"]
                 pool = s.pool.get_all(session)["Value"][0]
                 master = s.pool.get_master(session, pool)["Value"]
@@ -112,11 +106,11 @@ def runMainSequence(results, ram_warning, vt_warning, suppress_extra_cd_dialog):
                 s.session.logout(session)
 
                 # compare versions
-                master_ver = product.Version.from_string(software_version['product_version'])
-                if master_ver < product.THIS_PRODUCT_VERSION:
+                master_ver = product.Version.from_string(software_version['platform_version'])
+                if master_ver < product.THIS_PLATFORM_VERSION:
                     ret = True
-            except:
-                pass
+            except Exception as e:
+                logger.logException(e)
 
         return ret
 
@@ -125,6 +119,7 @@ def runMainSequence(results, ram_warning, vt_warning, suppress_extra_cd_dialog):
         results['preserve-settings'] = False
 
     seq = [
+        Step(uis.kernel_warning),
         Step(uis.welcome_screen),
         Step(uis.eula_screen),
         Step(uis.hardware_warnings,
diff --git a/tui/installer/screens.py b/tui/installer/screens.py
index ee75edc..901335d 100644
--- a/tui/installer/screens.py
+++ b/tui/installer/screens.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Installer TUI screens
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import string
 import datetime
@@ -48,6 +38,28 @@ def selectDefault(key, entries):
             return text, k
     return None
 
+# kernel-alt warning
+def kernel_warning(answers):
+    if answers.get("kernel-alt"):
+        button = snackutil.ButtonChoiceWindowEx(
+            tui.screen,
+            "Alternate kernel",
+            """WARNING: you chose to install our alternative kernel (kernel-alt).
+
+It is based on our main kernel + upstream kernel.org patches, so it should be stable by construction. However it receives less testing than the main kernel.
+
+A boot menu entry for kernel-alt will be added, but we will still boot the main kernel by default.
+
+If kernel-alt works BETTER than the main kernel for you, TELL US so that we may fix the main kernel!
+""",
+            ['Ok', 'Reboot'], width=60)
+
+        if button == 'ok' or button is None:
+            return True
+        else:
+            return EXIT
+    return True
+
 # welcome screen:
 def welcome_screen(answers):
     driver_answers = {'driver-repos': []}
@@ -172,8 +184,7 @@ def hardware_warnings(answers, ram_warning, vt_warning):
 
 def overwrite_warning(answers):
     warning_string = "Continuing will result in a clean installation, all existing configuration will be lost."
-    if PRODUCT_VERSION:
-        warning_string += "\n\nAlternatively, please contact a Technical Support Representative for the recommended upgrade path."
+    warning_string += "\n\nAlternatively, please contact a Technical Support Representative for the recommended upgrade path."
 
     button = snackutil.ButtonChoiceWindowEx(
         tui.screen,
@@ -515,6 +526,56 @@ def setup_runtime_networking(answers):
     # Get the answers from the user
     return tui.network.requireNetworking(answers, defaults)
 
+def raid_array_ui(answers):
+    disk_entries = sorted_disk_list()
+    raid_disks = [de for de in disk_entries if diskutil.is_raid(de)]
+    raid_slaves = [slave for master in raid_disks for slave in diskutil.getDeviceSlaves(master)]
+    entries = []
+    for de in disk_entries:
+        if de not in raid_slaves and de not in raid_disks:
+            vendor, model, size = diskutil.getExtendedDiskInfo(de)
+            string_entry = "%s - %s [%s %s]" % (
+                diskutil.getHumanDiskName(de), diskutil.getHumanDiskSize(size), vendor, model)
+            entries.append((string_entry, de))
+    if len(entries) < 2:
+        return SKIP_SCREEN
+    text = TextboxReflowed(54, "Do you want to group disks in a software RAID 1 array?  \n\n" +
+                           "The array will be created immediately and erase all the target disks.")
+    buttons = ButtonBar(tui.screen, [('Create', 'create'), ('Back', 'back')])
+    scroll, _ = snackutil.scrollHeight(3, len(entries))
+    cbt = CheckboxTree(3, scroll)
+    for (c_text, c_item) in entries:
+        cbt.append(c_text, c_item, False)
+    gf = GridFormHelp(tui.screen, 'RAID Array', 'guestdisk:info', 1, 4)
+    gf.add(text, 0, 0, padding=(0, 0, 0, 1))
+    gf.add(cbt, 0, 1, padding=(0, 0, 0, 1))
+    gf.add(buttons, 0, 3, growx=1)
+    gf.addHotKey('F5')
+
+    tui.update_help_line([None, "<F5> disk info"])
+    loop = True
+    while loop:
+        rc = gf.run()
+        if rc == 'F5':
+            disk_more_info(cbt.getCurrent())
+        else:
+            loop = False
+    tui.screen.popWindow()
+    tui.screen.popHelpLine()
+
+    button = buttons.buttonPressed(rc)
+    if button == 'create':
+        selected = cbt.getSelection()
+        txt = 'The content of the disks %s will be deleted when you activate "Ok"' % (str(selected))
+        title = 'RAID array creation'
+        confirmation = snackutil.ButtonChoiceWindowEx(tui.screen, title, txt, ('Ok', 'Cancel'), 40, default=1)
+        if confirmation == 'ok':
+            answers['raid'] = {'/dev/md127': selected}
+            tui.progress.showMessageDialog("Please wait", "Creating raid array...")
+            diskutil.create_raid(answers['raid'])
+            tui.progress.clearModelessDialog()
+    return REPEAT_STEP
+
 def disk_more_info(context):
     if not context: return True
 
@@ -543,14 +604,18 @@ def disk_more_info(context):
     return True
 
 def sorted_disk_list():
-    return sorted(diskutil.getQualifiedDiskList(),
-                  lambda x, y: len(x) == len(y) and cmp(x,y) or (len(x)-len(y)))
+    return sorted(set(diskutil.getQualifiedDiskList()),
+                  lambda x, y: len(x) == len(y) and cmp(x, y) or (len(x) - len(y)))
+
+def filter_out_raid_member(diskEntries):
+    raid_disks = [de for de in diskEntries if diskutil.is_raid(de)]
+    raid_slaves = set(member for master in raid_disks for member in diskutil.getDeviceSlaves(master))
+    return [e for e in diskEntries if e not in raid_slaves]
 
 # select drive to use as the Dom0 disk:
 def select_primary_disk(answers):
     button = None
-    diskEntries = sorted_disk_list()
-
+    diskEntries = filter_out_raid_member(sorted_disk_list())
     entries = []
     target_is_sr = {}
     min_primary_disk_size = constants.min_primary_disk_size
@@ -595,7 +660,7 @@ def select_primary_disk(answers):
 
 You may need to change your system settings to boot from this disk.""" % (MY_PRODUCT_BRAND),
             entries,
-            ['Ok', 'Back'], 55, scroll, height, default, help='pridisk:info',
+            ['Ok', 'Software RAID', 'Back'], 55, scroll, height, default, help='pridisk:info',
             hotkeys={'F5': disk_more_info})
 
         tui.screen.popHelpLine()
@@ -622,7 +687,12 @@ You may need to change your system settings to boot from this disk.""" % (MY_PRO
             else:
                 answers["preserve-first-partition"] = 'false'
 
-    if button is None: return SKIP_SCREEN
+    # XCP-ng: we replaced `SKIP_SCREEN` by `RIGHT_FORWARDS` for RAID support to avoid a loop after raid creation
+    if button is None: return RIGHT_FORWARDS
+
+    # XCP-ng
+    if button == 'software raid':
+        return raid_array_ui(answers)
 
     return RIGHT_FORWARDS
 
@@ -647,7 +717,7 @@ def check_sr_space(answers):
     return EXIT
 
 def select_guest_disks(answers):
-    diskEntries = sorted_disk_list()
+    diskEntries = filter_out_raid_member(sorted_disk_list())
 
     # CA-38329: filter out device mapper nodes (except primary disk) as these won't exist
     # at XenServer boot and therefore cannot be added as physical volumes to Local SR.
@@ -682,16 +752,19 @@ def select_guest_disks(answers):
     cbt = CheckboxTree(3, scroll)
     for (c_text, c_item) in entries:
         cbt.append(c_text, c_item, c_item in currently_selected)
-    txt = "Enable thin provisioning"
-    if len(BRAND_VDI) > 0:
-        txt += " (Optimized storage for %s)" % BRAND_VDI
+    txt = "Use EXT instead of LVM for local storage repository"
     tb = Checkbox(txt, srtype == constants.SR_TYPE_EXT and 1 or 0)
 
-    gf = GridFormHelp(tui.screen, 'Virtual Machine Storage', 'guestdisk:info', 1, 4)
+    explanations = Textbox(54, 2,
+                           "LVM: block based. May be faster. Thick provisioning.\n"
+                           "EXT: file based. May be slower. Thin provisioning.")
+
+    gf = GridFormHelp(tui.screen, 'Virtual Machine Storage', 'guestdisk:info', 1, 5)
     gf.add(text, 0, 0, padding=(0, 0, 0, 1))
     gf.add(cbt, 0, 1, padding=(0, 0, 0, 1))
-    gf.add(tb, 0, 2, padding=(0, 0, 0, 1))
-    gf.add(buttons, 0, 3, growx=1)
+    gf.add(tb, 0, 2, padding=(0, 0, 0, 0))
+    gf.add(explanations, 0, 3, padding=(0, 0, 0, 1))
+    gf.add(buttons, 0, 4, growx=1)
     gf.addHotKey('F5')
 
     tui.update_help_line([None, "<F5> more info"])
diff --git a/tui/network.py b/tui/network.py
index 4ad1c23..faf87dc 100644
--- a/tui/network.py
+++ b/tui/network.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# TUI Network configuration screens
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import uicontroller
 from uicontroller import LEFT_BACKWARDS, RIGHT_FORWARDS, REPEAT_STEP
diff --git a/tui/progress.py b/tui/progress.py
index 8857e9f..a651f22 100644
--- a/tui/progress.py
+++ b/tui/progress.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Text user interface progress and message functions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from snack import *
 import tui
diff --git a/tui/repo.py b/tui/repo.py
index 46f2850..2a23d98 100644
--- a/tui/repo.py
+++ b/tui/repo.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2009 Citrix, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of Citrix, Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Text user interface repository handling functions
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from snack import *
 import constants
@@ -99,6 +89,9 @@ def select_repo_source(answers, title, text, require_base_repo=True):
     entries = [ ENTRY_LOCAL ]
 
     default = ENTRY_LOCAL
+    if answers.get('netinstall'):
+        entries = []
+        default = ENTRY_URL
     if len(answers['network-hardware'].keys()) > 0:
         entries += [ ENTRY_URL, ENTRY_NFS ]
 
@@ -146,6 +139,8 @@ def get_url_location(answers, require_base_repo):
             user_field.set(answers['source-address'].getUsername())
         if answers['source-address'].getPassword() is not None:
             passwd_field.set(answers['source-address'].getPassword())
+    else:
+        url_field.set('http://mirrors.xcp-ng.org/netinstall/8.3')
 
     done = False
     while not done:
diff --git a/uicontroller.py b/uicontroller.py
index e9e95bf..d1371ce 100644
--- a/uicontroller.py
+++ b/uicontroller.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# User interface controller
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 from xcp import logger
 
diff --git a/upgrade.py b/upgrade.py
index a985c60..ec8d910 100644
--- a/upgrade.py
+++ b/upgrade.py
@@ -1,17 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Upgrade paths
-#
-# written by Andrew Peace
-
-# This stuff exists to hide ugliness and hacks that are required for upgrades
-# from the rest of the installer.
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import re
diff --git a/util.py b/util.py
index 1292096..c304310 100644
--- a/util.py
+++ b/util.py
@@ -1,14 +1,4 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
-###
-# XEN CLEAN INSTALLER
-# Utility functions for the clean installer
-#
-# written by Andrew Peace
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import os.path
diff --git a/xelogging.py b/xelogging.py
index 6770535..8509642 100644
--- a/xelogging.py
+++ b/xelogging.py
@@ -1,15 +1,6 @@
-# Copyright (c) 2005-2006 XenSource, Inc. All use and distribution of this
-# copyrighted material is governed by and subject to terms and conditions
-# as licensed by XenSource, Inc. All other rights reserved.
-# Xen, XenSource and XenEnterprise are either registered trademarks or
-# trademarks of XenSource Inc. in the United States and/or other countries.
-
 #!/usr/bin/env python
-###
-# XEN CLEAN INSTALLER
-# Logging functions
-#
-# written by Andrew Peace
+
+# SPDX-License-Identifier: GPL-2.0-only
 
 import os
 import shutil
@@ -37,6 +28,7 @@ def collectLogs(dst, tarball_dir=None):
     os.system("ps axf >%s/processes-log 2>&1" % dst)
     os.system("vgscan -P >%s/vgscan-log 2>&1" % dst)
     os.system("cat /var/log/multipathd >%s/multipathd-log 2>&1" % dst)
+    os.system("rpm -qa >%s/rpm-qa-log 2>&1" % dst)
 
     if not tarball_dir:
         tarball_dir = dst
